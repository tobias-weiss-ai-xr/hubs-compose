global
    log stdout format raw local0

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

resolvers docker
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry   1s
    hold other      30s
    hold refused    30s
    hold nx         30s
    hold timeout    30s
    hold valid      10s
    hold obsolete   30s

frontend http_front
    # listen on both HTTP and HTTPS - never comment out both binds
    bind *:80
    bind *:443 ssl crt /etc/letsencrypt/haproxy/

    # Redirect all HTTP traffic to HTTPS
    http-request redirect scheme https unless { ssl_fc }

    # ACLs for domain routing
    acl host_hubs hdr(host) -i hubs.chemie-lernen.org hubs.tobias-weiss.org
    acl host_xwiki hdr(host) -i wiki.tobias-weiss.org wiki.chemie-lernen.org

    # Backend selection
    use_backend hubs_backend if host_hubs
    use_backend xwiki_backend if host_xwiki

    default_backend hubs_backend # Fallback

backend hubs_backend
    server hubs1 hubs-client:8080 check resolvers docker resolve-prefer ipv4

backend xwiki_backend
    server xwiki1 xwiki-web:8080 check resolvers docker resolve-prefer ipv4
