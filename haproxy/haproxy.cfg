global
    log stdout format raw local0

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

resolvers docker
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry   1s
    hold other      30s
    hold refused    30s
    hold nx         30s
    hold timeout    30s
    hold valid      10s
    hold obsolete   30s

frontend http_front
    # listen on both HTTP and HTTPS - never comment out both binds
    bind *:80
    bind *:443 ssl crt /etc/letsencrypt/haproxy/

    # Redirect all HTTP traffic to HTTPS
    http-request redirect scheme https unless { ssl_fc }

    # ACLs for domain routing
    acl host_hubs hdr(host) -i hubs.chemie-lernen.org hubs.tobias-weiss.org
    acl host_xwiki hdr(host) -i wiki.tobias-weiss.org wiki.chemie-lernen.org
    acl host_tobias hdr(host) -i tobias-weiss.org www.tobias-weiss.org next.tobias-weiss.org
    acl host_chemie hdr(host) -i chemie-lernen.org www.chemie-lernen.org
    acl host_graphwiz hdr(host) -i graphwiz.ai www.graphwiz.ai graphwiz.de www.graphwiz.de
    acl host_traefik_dash hdr(host) -i traefik.graphwiz.ai

    # Backend selection
    use_backend hugo_tobias_weiss if host_tobias
    use_backend hugo_chemie_lernen if host_chemie
    use_backend hugo_graphwiz if host_graphwiz
    use_backend traefik_dashboard if host_traefik_dash
    use_backend hubs_backend if host_hubs
    use_backend xwiki_backend if host_xwiki

    default_backend hugo_tobias_weiss # Fallback

backend hugo_tobias_weiss
    server hugo1 127.0.0.1:1315 check

backend hugo_chemie_lernen
    server hugo2 127.0.0.1:1313 check

backend hugo_graphwiz
    server hugo3 127.0.0.1:1314 check

backend traefik_dashboard
    server traefik1 127.0.0.1:8083 check

backend hubs_backend
    server hubs1 hubs-client:8080 check resolvers docker resolve-prefer ipv4

backend xwiki_backend
    server xwiki1 xwiki-web:8080 check resolvers docker resolve-prefer ipv4
